<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title> Map Tools </title>
    <meta name="title" content="Map Tools">
    <meta name="description" content="Online assistant for map">
    <meta name="keywords" content="x y converter, lat lng converter, coordinate converter, map, map tools, map assistant">

    <link rel="icon" type="image/png" href="images/logo.png">

    <link rel="stylesheet" href="plugins/ol/ol.css">
    <script src="plugins/jquery-3.7.1.min.js"></script>
    <script src="plugins/tailwind/tailwind.js"></script>
    <script src="plugins/tailwind/david-ai.min.js"></script>
    <script src="plugins/proj/proj4.js"></script>
    <script src="plugins/ol/ol.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4">
        <div class="flex justify-center mb-2">
            <img src="images/logo.png" alt="Logo" class="h-18">
        </div>
        <h1 class="text-3xl font-bold text-center mb-2"> Map Tools </h1>
        <p class="lead mb-4 text-center text-lg font-medium text-gray-700">
            Created by <a href="https://abolfazlmohajeri.ir" target="_blank"
                          class="text-[#1C274C] hover:text-[#1A2035] font-semibold underline"> Abolfazl Mohajeri </a>
        </p>

        <div class="flex justify-center">
            <div class="w-full max-w-3xl">
                <div id="input-error"
                     class="bg-red-100 border-l-4 border-red-500 text-red-700 shadow-md rounded-lg p-4 mb-4"
                     style="display: none;">
                    <span class="font-semibold"> Error: </span> Please enter valid coordinates!
                </div>
            </div>
        </div>

        <div class="flex justify-center mb-4">
            <div class="w-full max-w-3xl bg-white p-6 shadow-md rounded-lg">
                <div class="relative tab-group">
                    <div class="flex bg-stone-100 p-0.5 relative rounded-lg justify-center" role="tablist">
                        <div class="absolute top-1 left-0 right-0 translate-x-0 h-8 bg-white rounded-md shadow-sm transition-all duration-300 transform tab-indicator z-0"></div>
                        <button class="tab-link font-semibold text-sm active inline-block py-2 px-4 text-stone-800 transition-all duration-300 relative z-1 mr-1 cursor-pointer" data-dui-tab-target="map-tab">
                            Geometry Extractor
                        </button>
                        <button class="tab-link font-semibold text-sm inline-block py-2 px-4 text-stone-800 transition-all duration-300 relative z-1 mr-1 cursor-pointer" data-dui-tab-target="converter-tab">
                            Coordinate Converter
                        </button>
                    </div>
                    <div class="mt-4 tab-content-container">
                        <div id="map-tab" class="tab-content text-stone-500 text-sm block px-1">
                            <div class="w-full bg-white shadow-md rounded-lg">
                                <div id="map-container" class="h-100 w-full border rounded"></div>
                                <button id="clear-map"
                                        class="rounded-md bg-slate-800 py-2 px-4 border border-transparent text-center text-sm text-white transition-all shadow-md hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none cursor-pointer"
                                        type="button">
                                    Clear
                                </button>
                            </div>
                            <div class="flex items-center space-x-4 mt-3">
                                <div class="flex-2">
                                    <div class="w-full max-w-sm min-w-[200px]">
                                        <div class="relative">
                                            <label class="block text-lg text-[#1C274C] font-bold mb-1" for="draw-type-selector"> Select Draw Type </label>
                                            <select id="draw-type-selector"
                                                    class="w-full bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded pl-3 pr-8 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-400 shadow-sm focus:shadow-md appearance-none cursor-pointer">
                                                <option value="Point" selected> Point</option>
                                                <option value="LineString"> LineString</option>
                                                <option value="Polygon"> Polygon</option>
                                            </select>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.2" stroke="currentColor" class="h-5 w-5 ml-1 absolute top-10.5 right-2.5 text-slate-700">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-2">
                                    <div class="w-full max-w-sm min-w-[200px]">
                                        <div class="relative">
                                            <label class="block text-lg text-[#1C274C] font-bold mb-1" for="map-projection"> Select Output Projection </label>
                                            <select id="map-projection" class="w-full bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded pl-3 pr-8 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-400 shadow-sm focus:shadow-md appearance-none cursor-pointer">
                                                <option value="EPSG:3857" selected>EPSG:3857 (Web Mercator)</option>
                                                <option value="EPSG:4326">EPSG:4326 (WGS 84)</option>
                                            </select>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.2" stroke="currentColor" class="h-5 w-5 ml-1 absolute top-10.5 right-2.5 text-slate-700">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="converter-tab" class="tab-content text-stone-500 text-sm hidden px-1">
                            <div class="flex items-center space-x-4">
                                <div class="flex-2">
                                    <div class="w-full max-w-sm min-w-[200px]">
                                        <div class="relative">
                                            <label class="block text-lg text-[#1C274C] font-bold mb-1" for="projection-selector"> Select Input Projection </label>
                                            <select id="projection-selector"
                                                    class="w-full bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded pl-3 pr-8 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-400 shadow-sm focus:shadow-md appearance-none cursor-pointer">
                                                <option value="EPSG:3857" selected>EPSG:3857 (Web Mercator)</option>
                                                <option value="EPSG:4326">EPSG:4326 (WGS 84)</option>
                                            </select>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.2"
                                                 stroke="currentColor" class="h-5 w-5 ml-1 absolute top-11 right-2.5 text-slate-700">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                      d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-3">
                                    <label class="block text-lg text-[#1C274C] font-bold mb-1" for="input-coordinates"> Enter Coordinates </label>
                                    <input type="text" id="input-coordinates"
                                           class="w-full bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded pl-3 pr-8 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-400 shadow-sm focus:shadow-md appearance-none"
                                           placeholder="3857 X, Y or 4326 Longitude, Latitude">
                                </div>
                            </div>
                            <div class="mt-4 mb-6">
                                <h3 class="block text-lg text-[#1C274C] font-bold mb-2"> Valid Input Examples: </h3>
                                <p class="mb-3">
                                    <strong class="text-[#1C274C]"> EPSG:3857(X, Y): </strong>
                                    <code class="bg-gray-200 px-2 py-1 rounded"> 5714927.050508631, 4259384.060127694 </code>
                                </p>
                                <p>
                                    <strong class="text-[#1C274C]"> EPSG:4326(lng, lat): </strong>
                                    <code class="bg-gray-200 px-2 py-1 rounded"> 51.338063171, 35.699738067 </code>
                                </p>
                            </div>
                            <div class="flex justify-center">
                                <button id="convert-button"
                                        class="rounded-md bg-slate-800 py-2 px-4 border border-transparent text-center text-sm text-white transition-all shadow-md hover:shadow-lg focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none cursor-pointer"
                                        type="button">
                                    Convert
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-center mb-4" id="output-section" style="display: none;">
            <div id="output" class="w-full max-w-3xl bg-white p-6 shadow-md rounded-lg"></div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            const inputError = $('#input-error');
            const outputSection = $('#output-section');
            const output = $('#output');
            const source = new ol.source.Vector();
            $('.tab-link').on('click', function () {
                $('.tab-link').removeClass('font-bold');
                $(this).addClass('font-bold');
                inputError.hide();
                outputSection.hide();
                source.clear();
            });

            const map = new ol.Map({
                target: 'map-container',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM()
                    })
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([53.584972499936065, 32.24674047057724]),
                    zoom: 4.8
                })
            });
            const vectorLayer = new ol.layer.Vector({
                source: source,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({ color: 'rgba(71,65,65,0.2)' }),
                    stroke: new ol.style.Stroke({ color: '#1C274C', width: 2 }),
                    image: new ol.style.Circle({
                        radius: 5,
                        fill: new ol.style.Fill({ color: '#1C274C' })
                    })
                })
            });
            map.addLayer(vectorLayer);

            let draw = 'Point';
            addDrawInteraction(draw);
            const projectionSelector = document.getElementById("map-projection");
            const drawTypeSelector = document.getElementById("draw-type-selector");
            function addDrawInteraction(drawType) {
                draw = new ol.interaction.Draw({
                    source: source,
                    type: drawType
                });
                map.addInteraction(draw);
                draw.on('drawend', function (event) {
                    source.clear();
                    outputSection.show();
                    const feature = event.feature;
                    const geometry = feature.getGeometry();
                    const selectedProjection = projectionSelector.value;
                    let coords = geometry.getCoordinates();
                    coords = transformCoordinates(coords, drawType, selectedProjection);
                    console.log(coords)
                    output.html(`<h3 class="text-xl text-[#1C274C] font-bold mb-1">Drawn Geometry (${drawType} in ${selectedProjection})</h3>
                    <pre>${JSON.stringify(coords, null, 2).replaceAll(/(\d),\n\s*(\d)/g, '$1, $2')}</pre>`);
                });
            }
            function transformCoordinates(coords, geometryType, targetProjection) {
                if (geometryType === "Point") {
                    return ol.proj.transform(coords, "EPSG:3857", targetProjection);
                } else if (geometryType === "LineString") {
                    return coords.map(coord => ol.proj.transform(coord, "EPSG:3857", targetProjection));
                } else if (geometryType === "Polygon") {
                    return coords.map(ring => {
                        return ring.map(coord => ol.proj.transform(coord, "EPSG:3857", targetProjection));
                    });
                }
                return coords;
            }
            drawTypeSelector.addEventListener("change", function () {
                if (draw) {
                    map.removeInteraction(draw);
                }
                addDrawInteraction(drawTypeSelector.value);
            });
            $('#clear-map').click(function () {
                source.clear();
            });

            $('#convert-button').click(function () {
                const inputCoordinates = $('#input-coordinates').val().trim();
                if (inputCoordinates === '') {
                    inputError.show();
                    return;
                }
                inputError.hide();

                let result;
                const proj3857 = 'EPSG:3857';
                const proj4326 = 'EPSG:4326';
                const selectedProjection = $('#projection-selector').val();
                if (selectedProjection === proj3857) {
                    const regex = /^(-?\d+\.\d+),\s*(-?\d+\.\d+)$/;
                    const match = inputCoordinates.match(regex);
                    if (match) {
                        const x = parseFloat(match[1]);
                        const y = parseFloat(match[2]);
                        result = proj4(proj3857, proj4326, [x, y]);
                        output.html(`<h3 class="text-xl text-[#1C274C] font-bold mb-1">Converted to EPSG:4326</h3><b>Longitude:</b> ${result[0]}<br><b>Latitude:</b> ${result[1]}`);
                        outputSection.show();
                        return;
                    }
                } else if (selectedProjection === proj4326) {
                    const regex = /^(-?\d+\.\d+),\s*(-?\d+\.\d+)$/;
                    const match = inputCoordinates.match(regex);
                    if (match) {
                        const lng = parseFloat(match[1]);
                        const lat = parseFloat(match[2]);
                        result = proj4(proj4326, proj3857, [lng, lat]);
                        output.html(`<h3 class="text-xl text-[#1C274C] font-bold mb-1">Converted to EPSG:3857</h3><b>X:</b> ${result[0]}<br><b>Y:</b> ${result[1]}`);
                        outputSection.show();
                        return;
                    }
                }
                inputError.show();
                outputSection.hide();
            });
        });
    </script>
</body>
</html>